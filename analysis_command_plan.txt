# Analysis Command Plan: `analyze_data`

This document outlines the structure and functionality for a new Django management command `analyze_data`, designed to generate various reports and visualizations related to product consolidation and company-specific product data.

## 1. Command Structure: `analyze_data`

*   **Location:** `api/management/commands/analyze_data.py`
*   **Role:** This command will act as a dispatcher. It will parse command-line arguments and call the appropriate functions from the analysis utility directory to perform data extraction, processing, and visualization.

## 2. Logic Separation: `api/utils/analysis_utils/`

*   **New Directory:** All core logic for data analysis, processing, and plotting will reside in `api/utils/analysis_utils/`. This ensures modularity, reusability, and separation of concerns from the command itself.

## 3. Command Arguments

The `analyze_data` command will accept the following arguments:

*   **`--report <type>` (Required):** Specifies which type of analysis or report to generate.
    *   `overlap_heatmap`: Generates data for the product overlap heatmap.
    *   `company_product_counts`: Generates data for both "total products in stores" and "total unique products" per company.
    *   *(Future reports can be added here, e.g., `category_overlap`, `price_variance`)*

*   **`--output <format>` (Optional, default: `print`):** Determines how the processed data should be presented if the `--plot` flag is not used.
    *   `print`: Prints a human-readable summary to the console.
    *   `csv`: Saves the data to a CSV file.
    *   `json`: Saves the data to a JSON file.

*   **`--plot` (Optional flag):** If this flag is present, the command will attempt to generate and save a plot (e.g., a PNG file) directly. This requires plotting libraries (`matplotlib`, `seaborn`) to be installed in the environment. If this flag is *not* present, only the raw data will be outputted in the format specified by `--output`.

## 4. Detailed Breakdown of Reports

### 4.1. `overlap_heatmap` Report

*   **Concept:** A matrix (or heatmap) illustrating the number of common `Product` objects shared between every pair of `Company`s.
*   **Data Needed (from database):** For each `Product` object, identify all the `Company` objects that sell it (derived from `Product` -> `Price` -> `Store` -> `Company` relationships).
*   **Processing (in `analysis_utils`):**
    *   A dedicated function will query all `Product` objects.
    *   For each `Product`, it will collect the set of `Company` IDs linked to it.
    *   It will then construct a co-occurrence matrix: if Product X is sold by Company A and Company B, the count for the (A, B) cell in the matrix is incremented.
    *   (Optional: The matrix can be normalized to show percentage overlap).
*   **Output (if `--output` is `print`/`csv`/`json`):** A square matrix (e.g., a Pandas DataFrame) where rows and columns represent company names, and values are the overlap counts.
*   **Plotting (if `--plot`):** A heatmap generated using `seaborn`.

### 4.2. `company_product_counts` Report

*   **Concept:** Generates data for two bar charts:
    *   **Total Products "In Stores":** For each `Company`, the total count of individual `Price` entries (representing every product listing, even if it's the same `Product` listed multiple times or in different stores of the same company).
    *   **Total Unique Goods (`Product` objects):** For each `Company`, the total count of *distinct* `Product` objects that company sells.
*   **Data Needed (from database):**
    *   For "In Stores": All `Price` objects, linked to their `Company`.
    *   For "Unique Goods": All `Product` objects, linked to their `Company` (via `Price` and `Store`).
*   **Processing (in `analysis_utils`):**
    *   A function will group `Price` objects by `Company` and count them for the "In Stores" metric.
    *   Another part will group `Product` objects by `Company` and count the unique `Product` IDs for the "Unique Goods" metric.
*   **Output (if `--output` is `print`/`csv`/`json`):** A table (e.g., Pandas DataFrame) with columns such as `Company`, `Total In Stores`, `Total Unique Products`.
*   **Plotting (if `--plot`):** Two separate bar charts (or a grouped bar chart) generated using `matplotlib`/`seaborn`.

## 5. Proposed Internal Functions (within `api/utils/analysis_utils/`)

These functions will encapsulate the core logic:

*   `get_product_company_relationships()`: A foundational function to extract `(product_id, company_id)` tuples from the database. This will serve as a common data source for many reports.
*   `prepare_overlap_data(relationships)`: Processes the output of `get_product_company_relationships` to generate data suitable for the `overlap_heatmap`.
*   `prepare_company_product_counts_data(relationships)`: Processes the output of `get_product_company_relationships` (and potentially direct `Price` queries) to generate data for the `company_product_counts` report.
*   `save_report_data(data, report_type, output_format)`: Handles saving the processed data to CSV/JSON files or printing it to the console.
*   `generate_plot(data, report_type, output_path)`: Handles generating and saving the plots (requires plotting libraries).
