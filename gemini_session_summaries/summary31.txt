## Summary of Changes for Cart Splitting and Optimization

This session focused on implementing the cart splitting and optimization feature, including both backend API development and frontend integration.

### Backend Changes:

1.  **`api/views/store_list_view.py` (New File):**
    *   Created a new API view `StoreListView` to handle requests for nearby store IDs.
    *   This view accepts `postcode` and `radius` as query parameters.
    *   It uses the `Postcode` model and the `get_nearby_stores` utility to find stores within the specified radius and returns a list of their IDs.

2.  **`api/urls.py` (Modified):**
    *   Added a new URL path `stores/nearby/` that points to the `StoreListView`.
    *   Renamed the URL path for `CartOptimizationView` from `cart/optimize/` to `cart/split/` to better reflect its purpose.

3.  **`api/views/product_list_view.py` (Modified):**
    *   Updated the `ProductListView` to accept a comma-separated list of `store_ids` as a query parameter instead of `postcode` and `radius`.
    *   The product queryset is now filtered based on these provided `store_ids`, ensuring that only products available in the selected stores are returned.

4.  **`api/views/cart_optimization_view.py` (Modified):**
    *   Removed the redundant `SplitCartView` class, as the existing `CartOptimizationView` already provided the necessary functionality for cart optimization.

### Frontend Changes:

1.  **`frontend/src/App.jsx` (Modified):**
    *   Introduced a new state variable `nearbyStoreIds` to store the IDs of stores relevant to the user's location.
    *   Added a `useEffect` hook to fetch these `nearbyStoreIds` from the new `/api/stores/nearby/` endpoint whenever the `userLocation` changes.
    *   Passed `nearbyStoreIds` as a prop to `ProductGrid` and `SubstitutionPage` components.
    *   Added a new route `/final-cart` to render the `FinalCartPage` component.

2.  **`frontend/src/components/ProductGrid.jsx` (Modified):**
    *   Updated the component to accept `nearbyStoreIds` as a prop instead of `userLocation`.
    *   Modified the `fetchProducts` function to use `nearbyStoreIds` (joined as a comma-separated string) in the API call to `/api/products/` for filtering.

3.  **`frontend/src/pages/SubstitutionPage.jsx` (Modified):**
    *   Updated the `useEffect` hook for fetching substitutes to use the `nearbyStoreIds` prop in the API call to `/api/products/{primaryItem.product.id}/substitutes/`.
    *   Modified the `handleViewFinalCart` function (triggered by the "View Final Cart" button) to navigate to the `/final-cart` page.
    *   The `cart` data (formatted as a list of lists of product IDs and quantities) and the `nearbyStoreIds` are now passed as state to the `FinalCartPage` during navigation.

4.  **`frontend/src/pages/FinalCartPage.jsx` (New File & Modified):**
    *   Created a new React component `FinalCartPage`.
    *   This page receives the `cart` data and `store_ids` from the navigation state.
    *   It makes a POST request to the `/api/cart/split/` endpoint with this data.
    *   It then displays the optimized shopping plan, including total cost, baseline cost, savings, and a breakdown of items per store.
    *   The API endpoint in this file was updated from `/api/cart/optimize/` to `/api/cart/split/` to match the backend URL change.

5.  **`frontend/package.json` (Modified):**
    *   Added `axios` as a dependency and installed it using `npm install axios` to resolve the import error in `FinalCartPage.jsx`.

These changes establish a clear separation of concerns, improve efficiency by fetching store IDs only once per location change, and provide a robust mechanism for cart optimization and display.