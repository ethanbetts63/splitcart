# Cart and Substitution Management Refactor Plan

## Objective
Refactor the cart and substitution management to centralize all substitution data on the backend. The frontend will only interact with the backend to modify the cart (add/remove items, add/approve/reject substitutions) and to trigger cart optimization. The frontend will no longer store potential substitutes locally.

## Current Understanding

*   An existing `CartSubstitution` model (`users/models/cart_substitution.py`) links an `original_cart_item` to a `substituted_product` with a `quantity`.
*   The `CartSubstitution` model has been updated with an `is_approved` boolean field to differentiate between potential and approved substitutes.
*   The frontend currently fetches *potential* substitutes and stores them locally in `CartContext.potentialSubstitutes`.
*   The `optimizeCartAPI` expects a "slot" structure, which the frontend currently constructs.
*   A "slot" is a conceptual grouping of an original `CartItem` and its associated `CartSubstitution` instances (especially those marked `is_approved`), not a distinct Django model.

## Identified Problems and Proposed Solutions

### Problem 1: API for managing potential and approved substitutes

**Description:** The current API doesn't support adding potential substitutes to the cart directly from the product tile, nor does it provide clear endpoints for approving, rejecting, or updating `CartSubstitution` instances.

**Proposed Solution:**
1.  **Automatic Generation of Potential Substitutes (Backend):**
    *   **New Utility Class:** A `SubstituteManager` class has been created in `data_management/utils/cart_optimization/substitute_manager.py` to encapsulate the logic for finding `ProductSubstitution` instances and creating `CartSubstitution` instances.
    *   When a `CartItem` is created via the `POST /api/carts/active/items/` endpoint, the backend will automatically use the `SubstituteManager` to identify potential substitutes for the `product.id` of the new `CartItem`.
    *   These identified potential substitutes will be created as `CartSubstitution` instances linked to the new `CartItem`, with `is_approved` initially set to `False`.
    *   This logic will be implemented within the `perform_create` method of `ActiveCartItemListCreateView` in `api/views/cart_views.py`.
2.  **API for Approving/Rejecting/Updating Substitutes:**
    *   Create new API endpoints to manage existing `CartSubstitution` instances:
        *   `PATCH /api/carts/active/items/<uuid:cart_item_id>/substitutions/<uuid:substitution_id>/`: Update the `is_approved` flag and/or `quantity` of a `CartSubstitution`. (Note: `substitution_id` refers to the `CartSubstitution` instance ID).
        *   `DELETE /api/carts/active/items/<uuid:cart_item_id>/substitutions/<uuid:substitution_id>/`: Remove a `CartSubstitution` entirely.
3.  **Serializer Updates:**
    *   Update `CartItemSerializer` to include nested serialization for all associated `CartSubstitution` instances. This will ensure the frontend receives all substitution data (both approved and unapproved) when fetching the cart.

### Problem 2: Frontend `CartContext` stores redundant `potentialSubstitutes` and lacks backend interaction for substitutions

**Description:** The `CartContext` currently maintains a `potentialSubstitutes` state locally, which is no longer needed if all substitution data resides on the backend. It also lacks the necessary functions to interact with the new backend API for managing `CartSubstitution` instances.

**Proposed Solution:**
1.  **Remove `potentialSubstitutes` state:** Eliminate the `potentialSubstitutes` state variable from `CartContext.tsx`.
2.  **Update `CartItem` Type:** Ensure the `CartItem` TypeScript type includes a property for its associated `CartSubstitution` objects (e.g., `substitutions: CartSubstitution[]`).
3.  **New `CartContext` Functions:** Add the following functions to `CartContextType` and implement them in `CartProvider` to interact with the new backend API:
    *   `updateCartItemSubstitution(cartItemId: string, substitutionId: string, isApproved: boolean, quantity: number)`: Calls the `PATCH` API endpoint to update the `is_approved` status and/or quantity.
    *   `removeCartItemSubstitution(cartItemId: string, substitutionId: string)`: Calls the `DELETE` API endpoint to remove a `CartSubstitution`.
    *   (The `addCartItemSubstitution` function is now implicitly handled by the backend when a `CartItem` is created, so a direct frontend call for this specific purpose might not be needed, or it could be repurposed for manually adding a *specific* potential substitute if that UI is desired later).
4.  **`fetchActiveCart` Enhancement:** Ensure `fetchActiveCart` correctly fetches and populates the `CartItem` with all its associated `CartSubstitution` instances from the backend.

### Problem 3: UI Integration in `CartPage.tsx` and `CartItemTile.tsx` needs to display and manage `CartSubstitution` instances

**Description:** The `CartPage.tsx` and `CartItemTile.tsx` currently do not display or allow interaction with `CartSubstitution` instances. They need to be updated to show both approved and unapproved substitutions and provide controls for managing them.

**Proposed Solution:**
1.  **`CartItemTile.tsx` Modifications:**
    *   Will receive the `CartItem` object, which now contains its `substitutions` (both approved and unapproved).
    *   Conditionally render a collapsible section (e.g., using an Accordion component) below the main product details if the `CartItem` has any associated `CartSubstitution` instances.
    *   Inside this section, iterate through the `CartItem.substitutions` and render `CartSubTile` for each.
    *   Pass down necessary props to `CartSubTile`: the `CartSubstitution` object itself, and callbacks for `onApprove`, `onReject`, `onQuantityChange`, `onRemove` (which will connect to the `CartContext` functions).
2.  **`CartSubTile.tsx` Enhancements:**
    *   Will receive a `CartSubstitution` object as a prop.
    *   Display the `substituted_product` details and its `quantity`.
    *   Visually indicate whether the `CartSubstitution` is `is_approved` (e.g., with a badge, different styling, or an "Approved" label).
    *   Provide interactive elements:
        *   A button/toggle to "Approve" (if `is_approved` is `False`).
        *   A button/toggle to "Reject" (if `is_approved` is `True`).
        *   Quantity controls that call `onQuantityChange`.
        *   A "Remove" button that calls `onRemove`.
    *   These interactive elements will trigger the appropriate callbacks passed from `CartItemTile`, which in turn will call the `CartContext` functions.
3.  **`CartPage.tsx` Modifications:**
    *   Ensure `CartPage` passes the `CartItem` object (which now includes `substitutions`) to `CartItemTile`.
    *   Ensure `CartPage` has access to `CartContext` functions for managing substitutions.
    *   **`SubstitutionPage.tsx`:**
        *   This page will need a significant refactor or potentially be removed/repurposed. If it remains, it will need to interact with the new backend-centric substitution management. For now, focus on the `CartPage` integration.

## To-Do List

1.  **Backend (Django):**
    *   [ ] **Modify `CartSubstitution` Model (`users/models/cart_substitution.py`):**
        *   [x] Add `is_approved = models.BooleanField(default=False)` field. (Already completed)
        *   [ ] Run `makemigrations` and `migrate`.
    *   [ ] **Implement Automatic Generation of Potential Substitutes:**
        *   [x] Create `SubstituteManager` class in `data_management/utils/cart_optimization/substitute_manager.py`. (Already completed)
        *   [ ] Modify `ActiveCartItemListCreateView` (`api/views/cart_views.py`) `perform_create` method to:
            *   [ ] After saving the new `CartItem`, use `SubstituteManager` to find potential substitutes.
            *   [ ] Create `CartSubstitution` instances for each potential substitute, linked to the new `CartItem`, with `is_approved=False`.
    *   [ ] **Create/Modify API Endpoints for `CartSubstitution` (`api/views/cart_views.py` or new `api/views/cart_substitution_views.py`):**
        *   [ ] Implement `PATCH /api/carts/active/items/<uuid:cart_item_id>/substitutions/<uuid:substitution_id>/` to update `is_approved` and `quantity`.
        *   [ ] Implement `DELETE /api/carts/active/items/<uuid:cart_item_id>/substitutions/<uuid:substitution_id>/` to remove a `CartSubstitution`.
    *   [ ] **Serializer Updates:**
        *   [ ] Create `CartSubstitutionSerializer`.
        *   [ ] Update `CartItemSerializer` to include nested `CartSubstitutionSerializer` for all associated substitutions.

2.  **Frontend (React/TypeScript):**
    *   [ ] **Update `types.ts`:**
        *   [ ] Modify `CartItem` type to include `substitutions: CartSubstitution[]`.
        *   [ ] Define `CartSubstitution` type mirroring the backend model (including `is_approved`).
    *   [ ] **`CartContext.tsx`:**
        *   [ ] Remove `potentialSubstitutes` state.
        *   [ ] Add `updateCartItemSubstitution`, `removeCartItemSubstitution` functions.
        *   [ ] Modify `fetchActiveCart` to correctly handle the new `substitutions` data within `CartItem`.
    *   [ ] **`CartSubTile.tsx`:**
        *   [ ] Update props to receive a `CartSubstitution` object.
        *   [ ] Implement UI to display `is_approved` status.
        *   [ ] Add interactive elements (buttons/toggles) for "Approve", "Reject", quantity change, and "Remove", connecting them to callbacks.
    *   [ ] **`CartItemTile.tsx`:**
        *   [ ] Update props to receive the `CartItem` object (which includes `substitutions`).
        *   [ ] Implement a collapsible section to display `CartSubTile` for each `CartSubstitution`.
        *   [ ] Pass appropriate callbacks from `CartContext` to `CartSubTile`.
    *   [ ] **`CartPage.tsx`:**
        *   [ ] Ensure `CartItemTile` receives the full `CartItem` object.
        *   [ ] Ensure `CartPage` has access to `CartContext` functions for managing substitutions.
    *   [ ] **`SubstitutionPage.tsx`:**
        *   [ ] This page will need a significant refactor or potentially be removed/repurposed. If it remains, it will need to interact with the new backend-centric substitution management. For now, focus on the `CartPage` integration.

## Impact on `cart_optimization_backend_plan.txt`

*   The `build_cart_slots_for_optimization` utility in the backend will now query `CartItem`s and their *approved* `CartSubstitution` instances (where `is_approved=True`) to construct the slots for the optimization algorithm.