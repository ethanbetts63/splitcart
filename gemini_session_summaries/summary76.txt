Session Summary:

This session focused on a major refactoring to ensure the Cart and SelectedStoreList are created and linked immediately upon user initialization, addressing the issue where substitution searches were being skipped.

1.  **Problem Identification**: Debugging revealed that `cart.selected_store_list` was `None` when `CartItem`s were created, even for authenticated users with selected stores. This was due to a timing issue and a bug in how `SelectedStoreList` was associated with users.
2.  **New Architecture Proposal**: A new architecture was proposed and approved: to create and link the `Cart` and `SelectedStoreList` atomically on the backend when a new user (anonymous or authenticated) is initialized.
3.  **Backend Implementation**:
    *   **`InitialSetupView`**: A new `APIView` was created in `api/views/initial_setup_view.py`. This view handles `POST` requests, uses `IsAuthenticatedOrAnonymous` permission, and atomically creates/retrieves an active `Cart` and a `SelectedStoreList` for the user, linking them if not already linked. It then serializes and returns both objects.
    *   **URL Configuration**: A new URL path (`/api/initial-setup/`) was added to `api/urls.py` to map to the `InitialSetupView`.
4.  **Frontend Implementation**:
    *   **`initialSetupApi.ts`**: A new service file was created in `frontend/src/services/` with `performInitialSetupAPI` to call the new backend endpoint.
    *   **`AuthContext.tsx`**: Modified to:
        *   Import `performInitialSetupAPI` and related types.
        *   Add state for `initialCart` and `initialStoreList`.
        *   Update the `useEffect` hook to call `performInitialSetupAPI` after user authentication/anonymous ID setup, storing the returned `cart` and `store_list` in its state.
        *   Update the `AuthContextType` and the provider value to include `initialCart` and `initialStoreList`.
    *   **`StoreListContext.tsx`**: Refactored `StoreListProvider` to:
        *   Accept `initialStoreList` as a prop.
        *   Remove its complex initialization `useEffect` hook.
        *   Use a new, simpler `useEffect` to set its state based on the `initialStoreList` prop.
    *   **`CartContext.tsx`**: Refactored `CartProvider` to:
        *   Accept `initialCart` as a prop.
        *   Remove its initialization `useEffect` hook.
        *   Use a new, simpler `useEffect` to set its state based on the `initialCart` prop.
    *   **`main.tsx`**: Modified to:
        *   Import `useAuth`.
        *   Create a `Root` component that uses `useAuth` to get `initialCart` and `initialStoreList`.
        *   Render `CartProvider` and `StoreListProvider` inside `AuthProvider`, passing the `initialCart` and `initialStoreList` as props.
        *   Display a loading message until `initialCart` and `initialStoreList` are available.

**Next Steps**: The system should now correctly initialize the cart and store list, and the substitution search should work as expected. The debug `print` statements in `ActiveCartItemListCreateView` can now be removed.