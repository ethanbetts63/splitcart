### Session Summary: Comprehensive Cart, Substitution, and Type Refactoring

**Objective:** The session began with the goal of refactoring the cart management system. This evolved into a comprehensive overhaul of the application's state management for carts and substitutions, a deep debugging of the frontend build process, the establishment of a robust TypeScript architecture, and the fixing of several related backend and frontend bugs.

**1. Initial Cart Refactoring & Backend Debugging:**

*   **`CartManager` Creation:** To centralize backend logic, a `CartManager` class was created. Its initial placement in `users/managers.py` led to a `Circular Import Error` with the `UserManager`.
*   **Resolution:** The issue was resolved by moving the `CartManager` to its own dedicated file, `users/cart_manager.py`, and updating the API views to import from the new location.

**2. Frontend State Management Overhaul:**

*   **`CartContext` Implementation:** A new `CartContext.tsx` was created to serve as the single source of truth for all cart-related state, replacing the old `ShoppingListContext`.
*   **The "Fetch-on-Add" Architecture:** Based on user feedback, we designed an efficient workflow where potential substitutes for a product will be fetched automatically in the background at the moment a user adds that product to their cart. This was implemented by:
    1.  Adding a `potentialSubstitutes` state to the `CartContext`.
    2.  Updating the `addItem` function in the context to trigger this background fetch.

**3. Deep Dive into TypeScript & Vite Debugging:**

*   **The Problem:** We encountered a series of persistent and misleading `SyntaxError` messages (e.g., `does not provide an export named 'Product'`) that seemed to contradict the code. The root cause was identified as a stale/corrupted cache in the Vite development server.
*   **The Investigation & Education:** We discussed the differences between `type` and `interface`, the implications of `tsconfig.json` settings like `verbatimModuleSyntax`, and the importance of a central "type hub" for maintainability.
*   **The Definitive Fix:** We implemented a systematic solution:
    1.  Created a central `frontend/src/types/index.ts` barrel file.
    2.  Consolidated all shared types (`Product`, `Cart`, `ApiResponse`, etc.) into the `/types` directory.
    3.  Updated all components (`CartContext`, `ProductTile`, `TrolleyPage`, etc.) to use explicit `import type { ... } from '@/types';` syntax.
    4.  Performed a "hard reset" (deleting `node_modules` and reinstalling) to clear the corrupted Vite cache, which finally resolved the persistent import errors.

**4. Substitution Workflow Integration:**

*   **`SubstitutionPage` Refactor:** This page was completely refactored to work with the new system. It now:
    1.  Uses the `useCart` hook to get the `currentCart` and the pre-fetched `potentialSubstitutes`.
    2.  Manages user-approved substitutes in its own local state.
    3.  Contains the logic to build the specific "list of lists" payload required by the backend and `POST` it to the optimization API.
*   **End-to-End Data Flow:** The optimization results are stored in a new `optimizationResult` state within the `CartContext`, making them available for the `FinalCartPage`.

**5. Code Cleanup and Final Bug Fixes:**

*   **File Deletion:** We identified and deleted several obsolete files from previous refactors, including `ShoppingListContext.tsx` and `SubstitutionContext.tsx`.
*   **Component Refactoring:** We refactored `NextButton.tsx` and `FinalCartPage.tsx` to remove their dependencies on the old contexts and use `useCart` instead.
*   **API Service Restoration:** Per user architectural preference for separation of concerns, we restored the deleted `frontend/src/services/storeListApi.ts` file to keep API logic separate from the `StoreListContext`.
*   **Backend `IntegrityError` & Frontend Double-Click Issue:**
    *   **Problem:** An `IntegrityError` occurred when adding an item that already existed in the cart, often triggered by a frontend UI lag causing double-clicks.
    *   **Resolution (Backend):** The `ActiveCartItemListCreateView` was modified to gracefully handle duplicate requests. If an item already exists in the cart, the backend now simply returns the existing item with a `200 OK` status instead of attempting to create a duplicate.
    *   **Resolution (Frontend):** The `AddToCartButton` was enhanced with a local loading state to disable the button immediately upon click, preventing accidental double-clicks and improving user feedback.

*   **`NameError: name 'Product' is not defined`:**
    *   **Cause:** A missing import of the `Product` model in `api/views/cart_views.py` after a refactoring step.
    *   **Resolution:** Added `from products.models import Product` to `api/views/cart_views.py`.

*   **`net::ERR_CONNECTION_REFUSED`:**
    *   **Cause:** The backend Django development server was not running.
    *   **Resolution:** Instructed the user to start the Django server in a separate terminal (`python manage.py runserver`).

*   **`TypeError: Cannot read properties of undefined (reading 'find')` in `TrolleyItemTile.tsx`:**
    *   **Cause:** `TrolleyItemTile.tsx` was incorrectly trying to access `items` directly from `useCart()` instead of `currentCart.items`.
    *   **Resolution:** Modified `TrolleyItemTile.tsx` to correctly access `currentCart?.items || []`.

*   **`404 Not Found` on `DELETE /api/carts/active/items/<uuid>/`:**
    *   **Cause:** The URL pattern in `api/urls.py` for `ActiveCartItemUpdateDestroyView` was using `<int:pk>` instead of `<uuid:pk>`, causing Django's URL dispatcher to not find the correct view for UUID-based primary keys.
    *   **Resolution:** The `api/urls.py` needs to be updated to use `<uuid:pk>` for the `ActiveCartItemUpdateDestroyView` to correctly match the UUID of the `CartItem`.
