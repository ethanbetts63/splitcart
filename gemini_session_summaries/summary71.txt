### Session Summary: Comprehensive Cart, Substitution, and Type Refactoring

**Objective:** The session began with the goal of refactoring the cart management system. This evolved into a comprehensive overhaul of the application's state management for carts and substitutions, a deep debugging of the frontend build process, the establishment of a robust TypeScript architecture, and the fixing of several related backend and frontend bugs.

**1. Initial Cart Refactoring & Backend Debugging:**

*   **`CartManager` Creation:** To centralize backend logic, a `CartManager` class was created. Its initial placement in `users/managers.py` led to a `Circular Import Error` with the `UserManager`.
*   **Resolution:** The issue was resolved by moving the `CartManager` to its own dedicated file, `users/cart_manager.py`, and updating the API views to import from the new location.

**2. Frontend State Management Overhaul:**

*   **`CartContext` Implementation:** A new `CartContext.tsx` was created to serve as the single source of truth for all cart-related state, replacing the old `ShoppingListContext`.
*   **The "Fetch-on-Add" Architecture:** Based on user feedback, we designed an efficient workflow where potential substitutes for a product are fetched automatically in the background at the moment a user adds that product to their cart. This was implemented by:
    1.  Adding a `potentialSubstitutes` state to the `CartContext`.
    2.  Updating the `addItem` function in the context to trigger this background fetch.

**3. Deep Dive into TypeScript & Vite Debugging:**

*   **The Problem:** We encountered a series of persistent and misleading `SyntaxError` messages (e.g., `does not provide an export named 'Product'`) that seemed to contradict the code. The root cause was identified as a stale/corrupted cache in the Vite development server.
*   **The Solution (Establishing a Type Hub):** We performed a systematic refactoring to fix the issue and establish a robust typing architecture:
    1.  **Configuration Analysis:** We reviewed `tsconfig.json` and identified that the strict `verbatimModuleSyntax: true` setting required explicit `import type` statements.
    2.  **Central Type Hub:** A central barrel file was created at `frontend/src/types/index.ts` to consolidate and re-export all shared types (`Product`, `Cart`, `ApiResponse`, etc.) from a single, consistent location.
    3.  **Code Refactoring:** All relevant components (`CartContext`, `ProductTile`, `TrolleyPage`, etc.) were updated to use the new central type hub with the correct `import type { ... } from '@/types';` syntax.
    4.  **Hard Reset:** We successfully cleared the corrupted Vite cache by deleting the `node_modules` directory and reinstalling all dependencies, which finally resolved the persistent import errors.

**4. Substitution Workflow Integration:**

*   **`SubstitutionPage` Refactor:** This page was completely refactored to work with the new system. It now:
    1.  Uses the `useCart` hook to get the `currentCart` and the pre-fetched `potentialSubstitutes`.
    2.  Manages user-approved substitutes in its own local state.
    3.  Contains the logic to construct the specific "list of lists" payload required by the backend.
*   **End-to-End Data Flow:** We connected the full workflow by implementing the API call on the `SubstitutionPage` to send the final approved cart to the `/api/cart/split/` endpoint and stored the response in a new `optimizationResult` state within the `CartContext`.

**5. Code Cleanup and Final Bug Fixes:**

*   **File Deletion:** We identified and deleted several obsolete files from previous refactors, including `ShoppingListContext.tsx` and `SubstitutionContext.tsx`.
*   **Component Refactoring:** We refactored `NextButton.tsx` and `FinalCartPage.tsx` to remove their dependencies on the old contexts and use `useCart` instead.
*   **API Service Restoration:** Per user architectural preference for separation of concerns, we restored the deleted `frontend/src/services/storeListApi.ts` file to keep API logic separate from the `StoreListContext`.
*   **Backend `IntegrityError`:** We fixed a `UNIQUE constraint failed` error that occurred when adding a duplicate item to the cart. The solution was twofold:
    1.  **Backend:** The `ActiveCartItemListCreateView` was made more robust to gracefully handle duplicate requests by checking if an item exists before attempting to create it.
    2.  **Frontend:** The `AddToCartButton` was enhanced with a local loading state to disable it on click, preventing accidental double-clicks and improving UI feedback.

**Final Outcome:** The session concluded with a fully functional and integrated cart and substitution system. The codebase is now cleaner, more robust, and follows a consistent and modern pattern for both state management and TypeScript type definitions.