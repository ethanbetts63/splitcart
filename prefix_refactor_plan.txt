# Brand and Prefix System Refactoring Plan

## 1. Executive Summary of Issues

The current system for managing brand names and barcode prefixes is fragmented, contains redundant components, and has data integrity flaws. Our investigation revealed the following key issues:

- **Fragmented Logic:** The overall process is split across three disconnected management commands: `update_db --prefixes`, `infer_and_reconcile_brands.py`, and `reconcile_brands.py`. This separation means that critical steps like prefix inference and brand reconciliation are not part of the main, automated data import pipeline.

- **Redundant Commands:** The `reconcile_brands.py` command exists almost entirely to report on data inconsistencies that are created by the fragmented nature of the other two processes. If the system were unified, this command would be obsolete.

- **Data Integrity Gaps:** Because the powerful inference and reconciliation logic in `infer_and_reconcile_brands.py` is not run automatically, the database contains thousands of brand discrepancies that should have been fixed.

- **Dead Code:** The `BrandPrefix` model contains a field, `shortest_inferred_prefix`, that is never used and should be removed.

- **Poor User Experience:** The current reconciliation logic overwrites user-friendly brand names (e.g., "Uncle Tobys") on products with their official corporate owner name from the GS1 registry (e.g., "Nestle Australia Ltd"). While technically correct for data normalization, this is bad for display purposes.

## 2. Analysis of Component Files

Here is a breakdown of the relevant files and their roles in the current, flawed system.

### File: `api/management/commands/infer_and_reconcile_brands.py`

- **Purpose:** This is the most critical and complex part of the system. It both infers plausible brand prefixes from product barcodes and then uses those inferences to find and fix incorrect brand assignments.
- **Inference Logic:** It implements the "network size" algorithm. For a given brand, it finds the longest common prefix (LCP) across all its product barcodes. It then intelligently shortens this prefix one digit at a time until the number of possible barcodes within that prefix's "address space" is greater than the number of products the brand actually has. This result is stored in the `longest_inferred_prefix` field.
- **Reconciliation Logic:** After inferring prefixes, it finds products in the database whose barcode matches an inferred prefix but whose brand name does not match the prefix's canonical brand. It then automatically corrects these products by merging the incorrect brand into the canonical one.
- **Problem:** This command contains the essential logic for maintaining data quality, but it is completely disconnected from the main `update_db` pipeline and must be run manually.

### File: `api/management/commands/update_db.py` (via `prefix_update_orchestrator.py`)

- **Purpose:** This process handles the data coming from the GS1 barcode scraper.
- **Logic:** It reads files of confirmed prefix data from an inbox, creates the official brand entry (e.g., "Nestle Australia Ltd"), and populates the `confirmed_official_prefix` field in the `BrandPrefix` model.
- **Problem:** This is a separate, manual step that is not integrated with the inference logic.

### File: `api/management/commands/reconcile_brands.py`

- **Purpose:** This command is a reporting tool that generates `brand_reconciliation_report.txt`.
- **Logic:** It reads all products and all brand prefixes (both confirmed and inferred). It then checks for discrepancies where a product's barcode suggests one brand but it is assigned another. It only reports these findings and does not modify any data.
- **Problem:** This command is redundant. The errors it reports are a symptom of the other processes being disconnected. In a unified system, this command would be unnecessary.

### File: `products/models/brand_prefix.py`

- **Purpose:** The Django model that stores brand prefix information.
- **Problem:** It contains the `shortest_inferred_prefix` field, which we have confirmed is unused and can be removed.

### File: `api/scrapers/gs1_company_scraper.py`

- **Purpose:** Scrapes the GS1 registry to get official company names and prefixes for barcodes.
- **Assessment:** This component is well-designed. It correctly prioritizes scraping brands that have a high number of products in the database but lack a confirmed prefix, making efficient use of the daily scrape limit.

### File: `api/database_updating_classes/brand_translation_table_generator.py`

- **Purpose:** Generates a Python file (`brand_translation_table.py`) that maps brand name variations to a canonical name.
- **Assessment:** This works as intended. It correctly identifies the canonical name (using the GS1 name if available) and maps other found variations to it.
