# Savings Calculation Upgrade Plan

## Goal
To improve the accuracy and performance of the savings calculation by intelligently selecting a small, high-value set of substitutes to analyze, especially for products with thousands of potential options.

## Core Idea: The "Substitution Portfolio"
For each item in a user's cart (the "anchor product"), we will not analyze all possible substitutes. Instead, we will build a "portfolio" of up to 10 of the best options to feed into the optimization solver. This makes the calculation faster and more realistic.

## The Selection Algorithm

This is a tiered process to select the best options for the portfolio.

**Step 0: Intelligent Graph Traversal**
- For the anchor product, find a group of high-quality substitutes by traversing the substitution graph on-the-fly, subject to two new rules:
- **1. Traversal Depth Limit:** The search for substitutes will be limited to a depth of **3 steps** from the anchor product. This prevents "semantic drift" in large substitution groups.
- **2. Selective Transitivity:** The traversal will only pass through size-agnostic substitution levels (LVL1, LVL4, LVL5, LVL6). The size-constrained levels (LVL2 and LVL3) are treated as "terminal" linksâ€”they will be included as substitutes if found, but will not be used as bridges to find more substitutes.

**Step 1: Conditional Culling by Price**
- **Tweak:** This step only runs if the number of substitutes found in Step 0 is large (e.g., greater than 20).
- Define a **Price Ceiling**: This is the price of the anchor product at its original store.
- Discard any substitute that costs more than this price ceiling.
- The remaining substitutes form our `candidate_list`. If this step is skipped, all substitutes are candidates.

**Step 2: Tier 1 Selection - The "Clones"**
- From the `candidate_list`, automatically select all Level 1 (same product, different size) and Level 2 (same brand, similar product) substitutes. These are the highest-quality matches.

**Step 3: Tier 2 Selection - The "Ambassadors"**
- To ensure options from other stores are considered, select one "ambassador" from each of the other stores involved in the analysis.
- The ambassador is chosen by finding the substitute available at that store with the **highest similarity score** to the anchor product.

**Step 4: Tier 3 Selection - The "Best of the Rest"**
- If the portfolio still has fewer than 10 options, fill the remaining slots.
- Sort the remaining candidates by their similarity score and add the top ones until the portfolio is full.

## Desired Outcome
- A more performant savings calculation, as the solver has a smaller, curated set of options to process.
- A more realistic savings figure that is based on a high-quality, diverse set of potential substitutes.
