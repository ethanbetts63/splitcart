
# Plan for the `update_database_from_archive` Command

This document outlines the plan for creating a new management command to update the database from archived JSON files.

---

### 1. Command Structure

- **File Location:** `api/management/commands/update_database_from_archive.py`
- **Arguments:** The command will have two optional, boolean flags:
    - `--stores`: Triggers the process to update stores from the `archive/company_data` directory.
    - `--products`: Triggers the process to update products and prices from the `archive/store_data` directory.
- **Default Behavior:** If no flags are provided, the command will run both the stores and products update processes sequentially.

---

### 2. Store Update Process (`--stores` flag)

This process populates the `Store` model.

- **Source Directory:** `C:\Users\ethan\coding\splitcart\api\data\archive\company_data`
- **Logic:**
    1.  The command will find and loop through each `.json` file in the source directory.
    2.  It will read and parse the JSON file, which is expected to contain a list of store data objects.
    3.  For each store object in the file, it will use the existing utility functions (`get_or_create_company`, `get_or_create_store`) to create or update the store's information in the database.

---

### 3. Product Update Process (`--products` flag)

This process populates the `Product` and `Price` models.

- **Source Directory:** `C:\Users\ethan\coding\splitcart\api\data\archive\store_data`
- **Logic:**
    1.  The command will recursively find all `.json` files within the source directory and its subdirectories.
    2.  For each file found, it will execute the following steps within a single database transaction to ensure data integrity:
        a. Read the file's metadata to identify the parent `Store`.
        b. Loop through the list of products contained in the file.
        c. For each product, call the existing database utility functions in the correct, redesigned order:
            i.   `get_or_create_category_hierarchy`
            ii.  `get_or_create_product`
            iii. `deactivate_product_price` (the new, granular function)
            iv.  `create_price`
    3.  This ensures that archived data is loaded correctly and does not re-introduce the "multiple active prices" issue.

---

### 4. Next Steps for Implementation

- Before writing the full implementation, the first step should be to read a sample JSON file from both the `company_data` and `store_data` directories.
- This will allow us to verify the exact structure of the archived data and confirm that the planned logic is perfectly aligned with it.
