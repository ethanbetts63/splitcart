## System Explanation: Splitcart Data Pipeline

**Overall Goal:** The Splitcart project aims to scrape product and price data from various Australian grocery stores (Coles, Woolworths, Aldi, IGA, etc.), process this raw data, and store it in a Django database for analysis and comparison.

**Key Components & Workflow:**

1.  **Scraping (`scrape` command):** Fetches raw product data from store websites and saves it as JSON files in `api/data/raw_data`.
2.  **Processing (`process_raw_data` command):** Takes the raw JSON files, cleans and standardizes the data, and saves it as processed JSON files in `api/data/processed_data`.
3.  **Database Update (`update_db` command):** This is the command we are currently working with. It's responsible for taking the processed data (or archived data) and populating the Django database models (Stores, Products, Prices, Categories).

    *   `update_db --stores`: Updates the database with store information. This can be done from newly discovered stores or from archived store data.
    *   `update_db --products`: Updates the database with product and price information from processed data files. This is the part we are focusing on.

**How `update_db --products` is Designed to Work (Ideal/Efficient Flow):**

The `update_db --products` command, after recent refactoring, is designed to use a highly efficient "bulk processing" approach for each processed data file:

*   **Consolidation:** Reads a processed JSON file and transforms its product data into a standardized in-memory format (`consolidated_data`).
*   **Batch Product Creation (`batch_create_new_products`):** Identifies all unique new products from the `consolidated_data` that don't already exist in the database. These are then inserted into the `Product` table in a single, fast `bulk_create` operation. It also builds a `product_cache` (a mapping of product keys to their database objects) for subsequent steps.
*   **Batch Price Creation (`batch_create_prices`):** Uses the `consolidated_data` and the `product_cache` to identify all price records. These are then inserted into the `Price` table in a single `bulk_create` operation.
*   **Batch Category Relationship Creation (`batch_create_category_relationships`):** Uses the `consolidated_data` and `product_cache` to ensure all necessary categories exist and then creates the many-to-many relationships between products and their categories in a `bulk_create` operation.

**What We Are Doing (Recent Changes & Fixes):**

We started by fixing a critical error where `update_db --products` was calling `get_or_create_product` incorrectly. This led us down a path of refactoring `update_db --products` to fully embrace the efficient bulk-processing pattern that `get_or_create_product` (and related batch functions) were designed for.

1.  **Initial Refactor:** Modified `update_products_from_processed.py` to use `batch_create_new_products`, `batch_create_prices`, and `batch_create_category_relationships`.
2.  **`AttributeError: 'NoneType' object has no attribute 'lower'` (Fixed):** This occurred because some product fields (like `name`, `brand`, `size`) were `null` in the JSON, and `.lower()` was called directly on `None`. Fixed by casting to `str()` before `.lower()`.
3.  **`AttributeError: 'NoneType' object has no attribute 'strip'` (Fixed):** Similar to the above, `strip()` was called on `None` values. Fixed by casting to `str()` before `.strip()`.
4.  **`UNIQUE constraint failed` (Fixed):** This happened during `bulk_create` when trying to insert a product that already existed in the database. Fixed by adding `ignore_conflicts=True` to the `bulk_create` call, which tells the database to skip duplicates instead of raising an error.
5.  **Price Records Not Being Created (Current Struggle):** We observed that "Pass 3: Batch creating prices" was not creating any price records.

**What We Are Currently Struggling On:**

The primary struggle right now is that **price records are not being created** by `batch_create_prices`.

*   **Initial Diagnosis:** We found that `batch_create_prices` was exiting early because its `store_cache` was empty. This meant no `Store` objects were in the database.
*   **Attempted Fix:** The user ran `python manage.py update_db --archive stores`, which successfully populated the database with `Store` objects.
*   **Remaining Problem:** Despite stores now being present, `batch_create_prices` still reports "No new price records to create." This is puzzling because the `store_cache` should now be populated, and the `price_current` field is correctly mapped.

**Next Steps for Debugging:**

We need to re-investigate why `batch_create_prices` is not creating prices. The debug prints I added previously (and which the user wants to keep) should help us pinpoint the exact reason for skipping price records (e.g., `store_id` not found, or `price` is `None`). We will need to carefully examine the output from the next run.
