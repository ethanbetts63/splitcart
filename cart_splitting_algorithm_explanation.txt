# Cart Splitting Algorithm Explained

This document details the step-by-step process of the shopping cart optimization algorithm. The goal is to find the mathematically cheapest combination of products and stores to fulfill a given shopping list, while respecting a limit on the number of stores to visit.

---

### Phase 1: Setup and Configuration

**Step 1: Generate a Shopping List**
For the purpose of benchmarking and inspection, the process begins by creating a random shopping list. A set number of unique "anchor products" (e.g., 20 for inspection, 100 for the full benchmark) are randomly selected from the products available in the database.

**Step 2: Select Stores for Comparison**
To ensure a fair, cross-competitor analysis, the algorithm intelligently selects the stores for the run:
- It iterates through each `Company` (e.g., Coles, Woolworths, IGA, Aldi) available in the database.
- For each company, it identifies "viable" stores, which are stores that have a minimum number of products with prices recorded (e.g., at least 20 products).
- From each company's pool of viable stores, it randomly selects **one** store.
- The final list of stores for the run is a collection of one store from each major competitor, ensuring a robust comparison.

---

### Phase 2: Building the "Possibility Space"

This phase constructs all the possible choices the optimizer can make to fulfill the shopping list.

**Step 3: Create Shopping "Slots"**
Each of the "anchor products" from the shopping list is treated as a "shopping slot." A slot represents the *need* for an item, for example, a "milk slot" or a "biscuit slot." The goal of the optimizer is to fill each slot in the cheapest way possible.

**Step 4: Gather All Substitutes**
For each slot, the algorithm queries the database to find **all** known substitutes for the original anchor product. This includes every level of substitution, from simple size variants (Level 1) to different brands with similar products (Level 3) and semantically similar items (Level 5).

**Step 5: Pre-optimize by Finding the Cheapest Option Per Store**
This is a key optimization to make the solver more efficient. Instead of considering every substitute at every store, the algorithm first determines the single best option for each slot *within each store*.
- For the "milk slot," it will look at the original milk and all its substitutes available at Coles and find the one with the absolute lowest price.
- It repeats this for Woolworths, Aldi, etc.

**Step 6: Finalize the Slots for the Solver**
After the pre-optimization, each shopping slot now contains a clean, simple list of the best possible options. For example, the "milk slot" passed to the solver looks like this:
- [cheapest_milk_option_at_Coles, cheapest_milk_option_at_Woolworths, cheapest_milk_option_at_Aldi]

---

### Phase 3: The Optimization (PuLP Solver)

This is the core of the process where the final decision is made.

**Step 7: Define the Optimization Problem**
The finalized list of slots is passed to the PuLP linear programming solver. The problem is defined with:
- **Objective:** To minimize the total cost of all chosen items.
- **Variables:** A binary (yes/no) decision variable is created for each option in each slot (e.g., "Should I buy the cheapest milk option from Coles?").
- **Constraints:**
    1.  **Fulfill All Slots:** Every shopping slot must be filled by exactly one option.
    2.  **Limit Store Visits:** The total number of unique stores visited must not exceed the allowed maximum (which is dynamically set to the number of companies being compared).

**Step 8: Solve the Problem**
The PuLP solver systematically explores all valid combinations of choices and is mathematically guaranteed to find the single combination that satisfies all constraints at the absolute lowest possible total cost.

---

### Phase 4: Output

**Step 9: Generate the Shopping Plan**
The algorithm translates the solver's optimal decision back into a human-readable shopping plan. It shows the total cost and provides a clear list of which items to buy at each specific store to achieve that minimum cost.
