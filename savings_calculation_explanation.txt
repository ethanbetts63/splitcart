# Explanation of the Savings Calculation Benchmark

This document explains the methodology used by the `savings_benchmark.py` script to calculate the potential savings a user can achieve by splitting their shopping cart across multiple stores and accepting product substitutions.

## 1. High-Level Goal

The primary goal is to answer the question: "How much money can a user save compared to a normal shopping routine?"

To do this, the benchmark simulates hundreds of random shopping carts and, for each one, compares the cost of a "Baseline Cart" (what a normal shopper would pay) against an "Optimized Cart" (the mathematically cheapest possible cart).

## 2. The Substitution System: The Foundation of Savings

Savings are only possible if the system has options to choose from. These options come from product substitutions, which are generated and classified into several levels of confidence:

- **LVL1: Same Brand, Same Product, Different Size.** (e.g., 600ml Coke vs 1.25L Coke). Transitive.
- **LVL2: Same Brand, Similar Product, Similar Size.** (e.g., "Coke Classic" vs "Coke No Sugar"). This link is size-constrained and therefore **Non-Transitive**.
- **LVL3: Different Brand, Similar Product, Similar Size.** (e.g., "Coke Classic" vs "Pepsi"). This link is also size-constrained and **Non-Transitive**.
- **LVL4: Different Brand, Similar Product, Different Size.** (e.g., 2L "Coke Classic" vs 1L "Pepsi"). Transitive.
- **LVL5: Same Category, Semantic Match.** Finds substitutes within the same category (e.g., "Coles Milk") using an AI model to compare product names. Transitive.
- **LVL6: Linked Category, Semantic Match.** Finds substitutes between linked categories (e.g., between "Coles Milk" and "Aldi Dairy") using the same AI model. This is key for finding matches for stores with unique product assortments. Transitive.

## 3. The Benchmark Process: A Step-by-Step Guide

The benchmark runs multiple simulations (e.g., 50 runs of 100 products each) to get a reliable average. Each simulation follows this process:

### Step 1: Generate a Random Cart Slot

For each of the 100 products in the simulated cart, we must find a list of valid substitutes. This is the most complex part of the process and uses our "Intelligent Portfolio" algorithm.

**A) Intelligent Graph Traversal:**
Instead of considering every possible substitute, we first find a high-quality group of candidates. We start with the original "anchor product" and traverse the substitution graph with two key rules:

  - **1. Traversal Depth Limit:** The search is limited to **3 steps** (or degrees of separation) from the anchor product. This finds nearby, relevant substitutes while preventing "semantic drift" where the meaning of a product changes over a long chain of substitutions.
  - **2. Selective Transitivity:** The search only "travels across" the size-agnostic links (LVL 1, 4, 5, 6). The size-constrained links (LVL 2, 3) are treated as "dead ends"â€”they are included as final substitutes but are not used as bridges to find more products.

**B) Building the "Substitution Portfolio":**
From the candidate group found above, we intelligently select a final list of up to 10 options:

  - **Size-Similarity Filter:** Before considering price, the candidate group is first filtered to include only substitutes that are reasonably close in size (e.g., within a 30% size tolerance) to the anchor product. This removes nonsensical comparisons early.
  - **Conditional Price Culling:** If the remaining candidate group is very large (e.g., > 20 options), we then perform a price culling. We define a **Price Ceiling** (the cheapest available price of the anchor product across all stores in the analysis) and discard any substitute that costs more.
  - **Tier 1 (Clones):** We automatically include all high-quality LVL1 and LVL2 substitutes from the candidate list.
  - **Tier 2 (Ambassadors):** To ensure we can find cross-store savings, we select one "ambassador" from each of the other competing stores. This ambassador is the product with the **highest similarity score** to our anchor product, ensuring it's a high-quality representative.
  - **Tier 3 (Best of the Rest):** We fill the remaining slots in our 10-item portfolio with the substitutes that have the highest similarity scores from the remaining pool.

### Step 2: Calculate the Two Costs

The final portfolio of ~10 high-quality, diverse options for each cart slot is then used to calculate the two different cart costs:

- **Optimized Cost:** A linear programming solver (PuLP) is given all the options for all the slots and finds the mathematically cheapest possible combination of products and stores.
- **Baseline Cost:** This simulates a "smart but normal" shopper. It calculates the cost of buying as much as possible from the single "best" store (the one that stocks the most items in the cart) and then making forced trips to other stores for any items that weren't available there.

### Step 3: Calculate the Final Saving

The final percentage is calculated with a simple formula:

`Savings % = ((Baseline Cost - Optimized Cost) / Baseline Cost) * 100`

## 4. Key Assumptions & Limitations

This benchmark operates on a few key assumptions:

- **User Flexibility:** It assumes the user is willing to accept any of the substitutes chosen by the optimizer and is willing to travel to multiple stores.
- **No Travel Costs:** The calculation does not currently factor in the real-world costs of travel between stores (e.g., time, fuel).
- **Baseline Behavior:** The "Baseline Cost" simulates a shopper who prioritizes minimizing the number of stores they visit above all else.
